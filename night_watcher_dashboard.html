<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Night_watcher Control Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0c0c0c 0%, #1a1a1a 100%);
            color: #e0e0e0;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            padding: 1rem 2rem;
            border-bottom: 3px solid #4a5568;
        }

        .header h1 {
            color: #f7fafc;
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .header p {
            color: #a0aec0;
            font-size: 1rem;
        }

        .main-container {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 2rem;
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .sidebar {
            background: #2d3748;
            border-radius: 12px;
            padding: 1.5rem;
            height: fit-content;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .nav-item {
            padding: 0.75rem 1rem;
            margin: 0.5rem 0;
            background: #4a5568;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
        }

        .nav-item:hover {
            background: #5a6578;
            transform: translateX(5px);
        }

        .nav-item.active {
            background: #3182ce;
            border-color: #63b3ed;
        }

        .nav-badge {
            position: absolute;
            top: 0.25rem;
            right: 0.25rem;
            background: #e53e3e;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .content {
            background: #2d3748;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .section h2 {
            color: #f7fafc;
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
            border-bottom: 2px solid #4a5568;
            padding-bottom: 0.5rem;
        }

        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .control-panel {
            background: #4a5568;
            border-radius: 8px;
            padding: 1.5rem;
            border: 1px solid #5a6578;
        }

        .control-panel h3 {
            color: #e2e8f0;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #cbd5e0;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            background: #2d3748;
            border: 1px solid #5a6578;
            border-radius: 6px;
            color: #e2e8f0;
            font-size: 0.9rem;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #63b3ed;
            box-shadow: 0 0 0 3px rgba(99, 179, 237, 0.1);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            margin: 0.25rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3182ce 0%, #2b77cb 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(49, 130, 206, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #d69e2e 0%, #b7791f 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
            color: white;
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .status-card {
            background: #4a5568;
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #5a6578;
        }

        .status-card h4 {
            color: #cbd5e0;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-card .value {
            font-size: 2rem;
            font-weight: bold;
            color: #63b3ed;
        }

        .log-container {
            background: #1a202c;
            border-radius: 8px;
            padding: 1rem;
            height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            border: 1px solid #4a5568;
        }

        .log-entry {
            margin-bottom: 0.5rem;
            padding: 0.25rem 0;
        }

        .log-entry.info {
            color: #63b3ed;
        }

        .log-entry.success {
            color: #68d391;
        }

        .log-entry.warning {
            color: #fbd38d;
        }

        .log-entry.error {
            color: #fc8181;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #2d3748;
            border-radius: 10px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3182ce, #63b3ed);
            width: 0%;
            transition: width 0.3s ease;
        }

        /* Review Queue Styles */
        .review-item {
            background: #4a5568;
            border-radius: 8px;
            margin: 1rem 0;
            border: 2px solid #d69e2e;
        }

        .review-header {
            padding: 1rem;
            border-bottom: 1px solid #5a6578;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .review-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            padding: 1rem;
        }

        .article-preview {
            background: #2d3748;
            padding: 1rem;
            border-radius: 6px;
            max-height: 300px;
            overflow-y: auto;
        }

        .analysis-preview {
            background: #2d3748;
            padding: 1rem;
            border-radius: 6px;
            max-height: 300px;
            overflow-y: auto;
        }

        .review-actions {
            padding: 1rem;
            border-top: 1px solid #5a6578;
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .template-badge {
            background: #3182ce;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .template-badge.testing {
            background: #d69e2e;
        }

        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-badge.review {
            background: #d69e2e;
            color: white;
        }

        .status-badge.valid {
            background: #38a169;
            color: white;
        }

        .status-badge.failed {
            background: #e53e3e;
            color: white;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .pulsing {
            animation: pulse 2s infinite;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #a0aec0;
        }

        .empty-state h3 {
            margin-bottom: 1rem;
            color: #cbd5e0;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üåô Night_watcher Control Dashboard</h1>
        <p>Intelligence Gathering & Analysis Framework</p>
    </div>

    <div class="main-container">
        <div class="sidebar">
            <div class="nav-item active" onclick="showSection('collector')">
                üì° Content Collector
            </div>
            <div class="nav-item" onclick="showSection('analyzer')">
                üîç Content Analyzer
            </div>
            <div class="nav-item" onclick="showSection('review-queue')">
                üëÅÔ∏è Review Queue
                <span class="nav-badge" id="review-count" style="display: none;">0</span>
            </div>
            <div class="nav-item" onclick="showSection('templates')">
                üìã Analysis Templates
            </div>
            <div class="nav-item" onclick="showSection('knowledge-graph')">
                üï∏Ô∏è Knowledge Graph
            </div>
            <div class="nav-item" onclick="showSection('vector-store')">
                üß† Vector Store
            </div>
            <div class="nav-item" onclick="showSection('monitoring')">
                üìä System Monitoring
            </div>
        </div>

        <div class="content">
            <!-- Content Collector Section -->
            <div id="collector" class="section active">
                <h2>Content Collector</h2>
                
                <div class="status-grid">
                    <div class="status-card">
                        <h4>Collection Status</h4>
                        <div class="value" id="collection-status">Idle</div>
                    </div>
                    <div class="status-card">
                        <h4>Total Documents</h4>
                        <div class="value" id="total-documents">0</div>
                    </div>
                    <div class="status-card">
                        <h4>Pending Analysis</h4>
                        <div class="value" id="pending-analysis">0</div>
                    </div>
                    <div class="status-card">
                        <h4>LLM Status</h4>
                        <div class="value" id="llm-status">Unknown</div>
                    </div>
                </div>

                <div class="control-grid">
                    <div class="control-panel">
                        <h3>Collection Controls</h3>
                        <div class="form-group">
                            <label>Collection Mode</label>
                            <select id="collection-mode">
                                <option value="auto">Auto (Smart Detection)</option>
                                <option value="incremental">Incremental (Since Last Run)</option>
                                <option value="first_run">First Run (From Jan 2025)</option>
                                <option value="full">Full (All Since Inauguration)</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="startCollection()">Start Collection</button>
                        <button class="btn btn-danger" onclick="stopCollection()">Stop Collection</button>
                        <div class="form-group" style="margin-top:1rem;">
                            <label>Anthropic API Key</label>
                            <input type="text" id="anthropic-key" placeholder="sk-...">
                            <button class="btn btn-small" onclick="saveAPIKey()">Save</button>
                        </div>
                    </div>

                    <div class="control-panel">
                        <h3>Quick Actions</h3>
                        <button class="btn btn-success" onclick="runFullPipeline()">Run Full Pipeline</button>
                        <button class="btn btn-warning" onclick="testLLMConnection()">Test LLM Connection</button>
                        <button class="btn btn-primary" onclick="refreshStatus()">Refresh Status</button>
                    </div>

                    <div class="control-panel">
                        <h3>Source Limits</h3>
                        <div id="sources-list"></div>
                    </div>
                </div>

                <div class="progress-bar">
                    <div class="progress-fill" id="task-progress"></div>
                </div>

                <div class="log-container" id="task-log">
                    <div class="log-entry info">[INFO] Ready to start collection</div>
                </div>
            </div>

            <!-- Content Analyzer Section -->
            <div id="analyzer" class="section">
                <h2>Content Analyzer</h2>
                
                <div class="status-grid">
                    <div class="status-card">
                        <h4>Analysis Status</h4>
                        <div class="value" id="analysis-status">Ready</div>
                    </div>
                    <div class="status-card">
                        <h4>Analyzed Documents</h4>
                        <div class="value" id="analyzed-documents">0</div>
                    </div>
                    <div class="status-card">
                        <h4>Pending Review</h4>
                        <div class="value" id="pending-review">0</div>
                    </div>
                </div>

                <div class="control-grid">
                    <div class="control-panel">
                        <h3>Analysis Controls</h3>
                        <div class="form-group">
                            <label>Analysis Templates</label>
                            <select id="analysis-templates" multiple size="3">
                                <option value="standard_analysis.json">Standard Analysis v1</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Max Articles to Analyze</label>
                            <input type="number" id="max-analyze" value="20" min="1" max="100">
                        </div>
                        <button class="btn btn-primary" onclick="startAnalysis()">Start Analysis</button>
                    </div>
                </div>

                <div class="log-container" id="analyzer-log">
                    <div class="log-entry info">[INFO] Content Analyzer ready</div>
                </div>
            </div>

            <!-- Review Queue Section -->
            <div id="review-queue" class="section">
                <h2>Review Queue</h2>
                
                <div class="status-grid">
                    <div class="status-card">
                        <h4>Items Pending Review</h4>
                        <div class="value" id="review-queue-count">0</div>
                    </div>
                    <div class="status-card">
                        <h4>Approved Today</h4>
                        <div class="value" id="approved-today">0</div>
                    </div>
                    <div class="status-card">
                        <h4>Rejected Today</h4>
                        <div class="value" id="rejected-today">0</div>
                    </div>
                </div>

                <div class="control-panel">
                    <h3>Queue Actions</h3>
                    <button class="btn btn-success btn-small" onclick="approveAll()">Approve All</button>
                    <button class="btn btn-danger btn-small" onclick="rejectAll()">Reject All</button>
                    <button class="btn btn-primary btn-small" onclick="refreshReviewQueue()">Refresh Queue</button>
                </div>

                <div id="review-queue-container">
                    <div class="empty-state">
                        <h3>No items in review queue</h3>
                        <p>Run analysis with a TESTING template to generate items for review</p>
                    </div>
                </div>
            </div>

            <!-- Templates Section -->
            <div id="templates" class="section">
                <h2>Analysis Templates</h2>
                
                <div class="control-grid">
                    <div class="control-panel">
                        <h3>Available Templates</h3>
                        <div id="templates-list">
                            <div class="template-item">
                                <div class="template-badge">PRODUCTION</div>
                                <strong>standard_analysis.json</strong>
                                <p>Standard 9-round analysis pipeline</p>
                            </div>
                        </div>
                    </div>

                    <div class="control-panel">
                        <h3>Template Actions</h3>
                        <button class="btn btn-primary" onclick="refreshTemplates()">Refresh Templates</button>
                        <button class="btn btn-warning" onclick="validateTemplate()">Validate Template</button>
                    </div>
                </div>

                <div class="log-container" id="templates-log">
                    <div class="log-entry info">[INFO] Templates ready</div>
                </div>
            </div>

            <!-- Knowledge Graph Section -->
            <div id="knowledge-graph" class="section">
                <h2>Knowledge Graph</h2>
                
                <div class="status-grid">
                    <div class="status-card">
                        <h4>Total Nodes</h4>
                        <div class="value" id="kg-nodes">0</div>
                    </div>
                    <div class="status-card">
                        <h4>Total Edges</h4>
                        <div class="value" id="kg-edges">0</div>
                    </div>
                </div>

                <div class="control-grid">
                    <div class="control-panel">
                        <h3>Graph Operations</h3>
                        <button class="btn btn-primary" onclick="buildKnowledgeGraph()">Build Graph</button>
                        <button class="btn btn-success" onclick="syncVectors()">Sync Vectors</button>
                    </div>
                </div>

                <div class="log-container" id="kg-log">
                    <div class="log-entry info">[INFO] Knowledge Graph ready</div>
                </div>
            </div>

            <!-- Vector Store Section -->
            <div id="vector-store" class="section">
                <h2>Vector Store</h2>
                
                <div class="status-grid">
                    <div class="status-card">
                        <h4>Total Vectors</h4>
                        <div class="value" id="total-vectors">0</div>
                    </div>
                </div>

                <div class="control-grid">
                    <div class="control-panel">
                        <h3>Search Interface</h3>
                        <div class="form-group">
                            <label>Search Query</label>
                            <input type="text" id="vector-search" placeholder="Enter search query...">
                        </div>
                        <button class="btn btn-primary" onclick="searchVectors()">Search</button>
                    </div>
                </div>

                <div class="log-container" id="vector-log">
                    <div class="log-entry info">[INFO] Vector Store ready</div>
                </div>
            </div>

            <!-- System Monitoring Section -->
            <div id="monitoring" class="section">
                <h2>System Monitoring</h2>
                
                <div class="status-grid">
                    <div class="status-card">
                        <h4>System Status</h4>
                        <div class="value" style="color: #68d391;">Online</div>
                    </div>
                    <div class="status-card">
                        <h4>Current Task</h4>
                        <div class="value" id="current-task">None</div>
                    </div>
                </div>

                <div class="log-container" id="system-log">
                    <div class="log-entry info">[INFO] System monitoring active</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API configuration
        const API_BASE = window.location.origin + '/api';
        
        // State
        let taskInterval = null;
        let statusInterval = null;
        let reviewQueue = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            refreshStatus();
            startStatusPolling();
            loadTemplates();
            refreshReviewQueue();
            loadSources();
        });

        // Navigation
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            document.getElementById(sectionId).classList.add('active');
            event.target.classList.add('active');

            // Auto-refresh review queue when section is opened
            if (sectionId === 'review-queue') {
                refreshReviewQueue();
            } else if (sectionId === 'collector') {
                loadSources();
            }
        }

        // API calls
        async function apiCall(endpoint, options = {}) {
            try {
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    ...options
                });
                
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('API call failed:', error);
                throw error;
            }
        }

        // Status updates
        async function refreshStatus() {
            try {
                const status = await apiCall('/status');
                
                // Update UI
                document.getElementById('total-documents').textContent = status.total_documents || 0;
                document.getElementById('pending-analysis').textContent = status.pending_analysis || 0;
                document.getElementById('analyzed-documents').textContent = status.analyzed_documents || 0;
                document.getElementById('kg-nodes').textContent = status.graph_nodes || 0;
                document.getElementById('kg-edges').textContent = status.graph_edges || 0;
                document.getElementById('total-vectors').textContent = status.vector_count || 0;
                document.getElementById('pending-review').textContent = status.pending_review || 0;
                document.getElementById('review-queue-count').textContent = status.pending_review || 0;
                
                // Update review badge
                const reviewCount = status.pending_review || 0;
                const badge = document.getElementById('review-count');
                if (reviewCount > 0) {
                    badge.textContent = reviewCount;
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }
                
                // LLM status
                const llmConnected = status.system?.llm_connected;
                document.getElementById('llm-status').textContent = llmConnected ? 'Connected' : 'Offline';
                document.getElementById('llm-status').style.color = llmConnected ? '#68d391' : '#fc8181';
                
                // Task status
                if (status.task_status?.running) {
                    document.getElementById('collection-status').textContent = 'Running';
                    document.getElementById('collection-status').parentElement.classList.add('pulsing');
                    document.getElementById('current-task').textContent = status.task_status.current_task || 'Unknown';
                    startTaskPolling();
                } else {
                    document.getElementById('collection-status').textContent = 'Idle';
                    document.getElementById('collection-status').parentElement.classList.remove('pulsing');
                    document.getElementById('current-task').textContent = 'None';
                }
                
            } catch (error) {
                logMessage('system-log', 'error', `Failed to refresh status: ${error.message}`);
            }
        }

        function startStatusPolling() {
            statusInterval = setInterval(refreshStatus, 5000);
        }

        // Task monitoring
        async function updateTaskStatus() {
            try {
                const taskStatus = await apiCall('/task-status');
                
                // Update progress
                const progress = taskStatus.progress || 0;
                document.getElementById('task-progress').style.width = progress + '%';
                
                // Update logs
                if (taskStatus.messages && taskStatus.messages.length > 0) {
                    const logContainer = document.getElementById('task-log');
                    logContainer.innerHTML = '';
                    
                    taskStatus.messages.forEach(msg => {
                        const entry = document.createElement('div');
                        entry.className = `log-entry ${msg.level}`;
                        entry.textContent = `[${msg.time}] ${msg.message}`;
                        logContainer.appendChild(entry);
                    });
                    
                    logContainer.scrollTop = logContainer.scrollHeight;
                }
                
                // Stop polling if task is done
                if (!taskStatus.running && taskInterval) {
                    clearInterval(taskInterval);
                    taskInterval = null;
                    refreshStatus();
                    refreshReviewQueue(); // Refresh review queue after task completion
                }
                
            } catch (error) {
                console.error('Failed to update task status:', error);
            }
        }

        function startTaskPolling() {
            if (!taskInterval) {
                updateTaskStatus();
                taskInterval = setInterval(updateTaskStatus, 1000);
            }
        }

        // Collection functions
        async function startCollection() {
            const mode = document.getElementById('collection-mode').value;
            
            try {
                await apiCall('/collect', {
                    method: 'POST',
                    body: JSON.stringify({ mode })
                });
                
                logMessage('task-log', 'info', 'Collection started');
                startTaskPolling();
                
            } catch (error) {
                logMessage('task-log', 'error', `Failed to start collection: ${error.message}`);
            }
        }

        async function stopCollection() {
            try {
                await apiCall('/collect/stop', { method: 'POST' });
                logMessage('task-log', 'info', 'Collection stop requested');
            } catch (error) {
                logMessage('task-log', 'error', `Failed to stop collection: ${error.message}`);
            }
        }

        async function saveAPIKey() {
            const key = document.getElementById('anthropic-key').value.trim();
            if (!key) return;
            try {
                await apiCall('/config', {
                    method: 'POST',
                    body: JSON.stringify({ llm_provider: { type: 'anthropic', model: 'claude-3-haiku-20240307', api_key: key } })
                });
                logMessage('task-log', 'success', 'API key saved');
            } catch (error) {
                logMessage('task-log', 'error', `Failed to save key: ${error.message}`);
            }
        }

        async function loadSources() {
            try {
                const sources = await apiCall('/sources');
                const container = document.getElementById('sources-list');
                container.innerHTML = '';
                sources.forEach((src, idx) => {
                    const div = document.createElement('div');
                    div.className = 'form-group';
                    div.innerHTML = `
                        <label>${src.name}</label>
                        <input type="number" id="limit-${idx}" value="${src.limit || 50}" min="1" style="width:80px;">
                        <button class="btn btn-small" onclick="updateSourceLimit('${src.url}', document.getElementById('limit-${idx}').value)">Save</button>
                    `;
                    container.appendChild(div);
                });
            } catch (error) {
                logMessage('task-log', 'error', `Failed to load sources: ${error.message}`);
            }
        }

        async function updateSourceLimit(url, limit) {
            try {
                await apiCall('/sources/update', {
                    method: 'POST',
                    body: JSON.stringify({ url, limit: parseInt(limit) })
                });
                logMessage('task-log', 'success', `Updated limit for ${url}`);
            } catch (error) {
                logMessage('task-log', 'error', `Failed to update source: ${error.message}`);
            }
        }

        // Analysis functions
        async function startAnalysis() {
            const maxArticles = parseInt(document.getElementById('max-analyze').value);
            const selector = document.getElementById('analysis-templates');
            const templates = Array.from(selector.selectedOptions).map(o => o.value);

            try {
                await apiCall('/analyze', {
                    method: 'POST',
                    body: JSON.stringify({
                        max_articles: maxArticles,
                        templates: templates
                    })
                });

                logMessage('analyzer-log', 'info', `Analysis started with templates: ${templates.join(', ')}`);
                startTaskPolling();
                
            } catch (error) {
                logMessage('analyzer-log', 'error', `Failed to start analysis: ${error.message}`);
            }
        }

        // Template functions
        async function loadTemplates() {
            try {
                const templates = await apiCall('/templates');
                const selector = document.getElementById('analysis-templates');
                const list = document.getElementById('templates-list');
                
                selector.innerHTML = '';
                list.innerHTML = '';
                
                templates.forEach(template => {
                    // Add to selector
                    const option = document.createElement('option');
                    option.value = template.filename;
                    option.textContent = `${template.name} (${template.status})`;
                    selector.appendChild(option);
                    
                    // Add to list
                    const item = document.createElement('div');
                    item.className = 'template-item';
                    item.style.marginBottom = '1rem';
                    item.innerHTML = `
                        <div class="template-badge ${template.status.toLowerCase()}">${template.status}</div>
                        <strong>${template.filename}</strong>
                        <p>${template.description || 'No description'}</p>
                        <small>Version: ${template.version || 'N/A'}</small>
                    `;
                    list.appendChild(item);
                });
                
            } catch (error) {
                logMessage('templates-log', 'error', `Failed to load templates: ${error.message}`);
            }
        }

        async function refreshTemplates() {
            await loadTemplates();
            logMessage('templates-log', 'success', 'Templates refreshed');
        }

        // Review Queue functions
        async function refreshReviewQueue() {
            try {
                const queue = await apiCall('/review-queue');
                reviewQueue = queue;
                
                const container = document.getElementById('review-queue-container');
                
                if (queue.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>No items in review queue</h3>
                            <p>Run analysis with a TESTING template to generate items for review</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = '';
                queue.forEach((item, index) => {
                    const reviewItem = createReviewItem(item, index);
                    container.appendChild(reviewItem);
                });
                
            } catch (error) {
                logMessage('system-log', 'error', `Failed to refresh review queue: ${error.message}`);
            }
        }

        function createReviewItem(item, index) {
            const div = document.createElement('div');
            div.className = 'review-item';
            div.innerHTML = `
                <div class="review-header">
                    <div>
                        <strong>${item.article.title}</strong>
                        <div class="template-badge ${item.template_status.toLowerCase()}">${item.template_name}</div>
                        <div class="status-badge ${item.validation_status.toLowerCase()}">${item.validation_status}</div>
                    </div>
                    <div>
                        <small>${item.article.source} ‚Ä¢ ${new Date(item.timestamp).toLocaleString()}</small>
                    </div>
                </div>
                <div class="review-content">
                    <div class="article-preview">
                        <h4>Article Content</h4>
                        <p><strong>Source:</strong> ${item.article.source}</p>
                        <p><strong>URL:</strong> <a href="${item.article.url}" target="_blank">${item.article.url}</a></p>
                        <div style="margin-top: 1rem; max-height: 200px; overflow-y: auto;">
                            ${item.article.content.substring(0, 500)}...
                        </div>
                    </div>
                    <div class="analysis-preview">
                        <h4>Analysis Results</h4>
                        <p><strong>Manipulation Score:</strong> ${item.manipulation_score || 'N/A'}/10</p>
                        <p><strong>Concern Level:</strong> ${item.concern_level || 'N/A'}</p>
                        <p><strong>Validation Reason:</strong> ${item.validation_reason}</p>
                        <div style="margin-top: 1rem;">
                            <strong>Authoritarian Indicators:</strong>
                            <ul style="margin-left: 1rem; margin-top: 0.5rem;">
                                ${(item.authoritarian_indicators || []).map(ind => `<li>${ind}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="review-actions">
                    <button class="btn btn-success btn-small" onclick="approveAnalysis(${index})">‚úì Approve</button>
                    <button class="btn btn-danger btn-small" onclick="rejectAnalysis(${index})">‚úó Reject</button>
                    <button class="btn btn-warning btn-small" onclick="retryAnalysis(${index})">üîÑ Retry</button>
                    <textarea placeholder="Optional notes..." id="notes-${index}" style="margin-left: 1rem; flex: 1;"></textarea>
                </div>
            `;
            return div;
        }

        async function approveAnalysis(index) {
            const item = reviewQueue[index];
            const notes = document.getElementById(`notes-${index}`).value;
            
            try {
                await apiCall('/review-queue/approve', {
                    method: 'POST',
                    body: JSON.stringify({ 
                        analysis_id: item.id,
                        notes: notes 
                    })
                });
                
                logMessage('system-log', 'success', `Approved analysis: ${item.article.title}`);
                refreshReviewQueue();
                refreshStatus();
                
            } catch (error) {
                logMessage('system-log', 'error', `Failed to approve: ${error.message}`);
            }
        }

        async function rejectAnalysis(index) {
            const item = reviewQueue[index];
            const notes = document.getElementById(`notes-${index}`).value;
            
            try {
                await apiCall('/review-queue/reject', {
                    method: 'POST',
                    body: JSON.stringify({ 
                        analysis_id: item.id,
                        notes: notes 
                    })
                });
                
                logMessage('system-log', 'warning', `Rejected analysis: ${item.article.title}`);
                refreshReviewQueue();
                refreshStatus();
                
            } catch (error) {
                logMessage('system-log', 'error', `Failed to reject: ${error.message}`);
            }
        }

        async function retryAnalysis(index) {
            const item = reviewQueue[index];
            
            try {
                await apiCall('/review-queue/retry', {
                    method: 'POST',
                    body: JSON.stringify({ analysis_id: item.id })
                });
                
                logMessage('system-log', 'info', `Retrying analysis: ${item.article.title}`);
                refreshReviewQueue();
                
            } catch (error) {
                logMessage('system-log', 'error', `Failed to retry: ${error.message}`);
            }
        }

        // Knowledge Graph functions
        async function buildKnowledgeGraph() {
            try {
                await apiCall('/build-kg', { method: 'POST' });
                logMessage('kg-log', 'info', 'Building knowledge graph');
                startTaskPolling();
            } catch (error) {
                logMessage('kg-log', 'error', `Failed to build graph: ${error.message}`);
            }
        }

        async function syncVectors() {
            try {
                await apiCall('/sync-vectors', { method: 'POST' });
                logMessage('vector-log', 'info', 'Synchronizing vectors');
                startTaskPolling();
            } catch (error) {
                logMessage('vector-log', 'error', `Failed to sync vectors: ${error.message}`);
            }
        }

        // Full pipeline
        async function runFullPipeline() {
            try {
                await apiCall('/pipeline', { method: 'POST' });
                logMessage('task-log', 'info', 'Full pipeline started');
                startTaskPolling();
            } catch (error) {
                logMessage('task-log', 'error', `Failed to start pipeline: ${error.message}`);
            }
        }

        // LLM test
        async function testLLMConnection() {
            try {
                const result = await apiCall('/test-llm', { method: 'POST' });
                logMessage('task-log', 'success', `LLM test: ${result.response || 'Connected'}`);
            } catch (error) {
                logMessage('task-log', 'error', `LLM test failed: ${error.message}`);
            }
        }

        // Vector search
        async function searchVectors() {
            const query = document.getElementById('vector-search').value;
            
            if (!query) {
                alert('Please enter a search query');
                return;
            }
            
            try {
                const results = await apiCall('/search', {
                    method: 'POST',
                    body: JSON.stringify({ query, limit: 10 })
                });
                
                logMessage('vector-log', 'success', `Found ${results.length} results`);
                
                // Display results
                results.forEach(result => {
                    logMessage('vector-log', 'info', `${result.name} (score: ${result.score.toFixed(3)})`);
                });
                
            } catch (error) {
                logMessage('vector-log', 'error', `Search failed: ${error.message}`);
            }
        }

        // Utility functions
        function logMessage(containerId, level, message) {
            const container = document.getElementById(containerId);
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry ${level}`;
            entry.textContent = `[${timestamp}] ${message}`;
            
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
            
            // Keep only last 50 entries
            while (container.children.length > 50) {
                container.removeChild(container.firstChild);
            }
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (statusInterval) clearInterval(statusInterval);
            if (taskInterval) clearInterval(taskInterval);
        });
    </script>
</body>
</html>
