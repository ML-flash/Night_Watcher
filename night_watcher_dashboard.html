<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Night_watcher Control Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0c0c0c 0%, #1a1a1a 100%);
            color: #e0e0e0;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            padding: 1rem 2rem;
            border-bottom: 3px solid #4a5568;
        }

        .header h1 {
            color: #f7fafc;
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .header p {
            color: #a0aec0;
            font-size: 1rem;
        }

        .main-container {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 2rem;
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .sidebar {
            background: #2d3748;
            border-radius: 12px;
            padding: 1.5rem;
            height: fit-content;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .nav-item {
            padding: 0.75rem 1rem;
            margin: 0.5rem 0;
            background: #4a5568;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .nav-item:hover {
            background: #5a6578;
            transform: translateX(5px);
        }

        .nav-item.active {
            background: #3182ce;
            border-color: #63b3ed;
        }

        .content {
            background: #2d3748;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        .section h2 {
            color: #f7fafc;
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
            border-bottom: 2px solid #4a5568;
            padding-bottom: 0.5rem;
        }

        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .control-panel {
            background: #4a5568;
            border-radius: 8px;
            padding: 1.5rem;
            border: 1px solid #5a6578;
        }

        .control-panel h3 {
            color: #e2e8f0;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #cbd5e0;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            background: #2d3748;
            border: 1px solid #5a6578;
            border-radius: 6px;
            color: #e2e8f0;
            font-size: 0.9rem;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #63b3ed;
            box-shadow: 0 0 0 3px rgba(99, 179, 237, 0.1);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            margin: 0.25rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3182ce 0%, #2b77cb 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(49, 130, 206, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #d69e2e 0%, #b7791f 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
            color: white;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .status-card {
            background: #4a5568;
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #5a6578;
        }

        .status-card h4 {
            color: #cbd5e0;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-card .value {
            font-size: 2rem;
            font-weight: bold;
            color: #63b3ed;
        }

        .log-container {
            background: #1a202c;
            border-radius: 8px;
            padding: 1rem;
            height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            border: 1px solid #4a5568;
        }

        .log-entry {
            margin-bottom: 0.5rem;
            padding: 0.25rem 0;
        }

        .log-entry.info {
            color: #63b3ed;
        }

        .log-entry.success {
            color: #68d391;
        }

        .log-entry.warning {
            color: #fbd38d;
        }

        .log-entry.error {
            color: #fc8181;
        }

        .source-item {
            background: #2d3748;
            padding: 1rem;
            margin: 0.5rem 0;
            border-radius: 6px;
            border-left: 4px solid #3182ce;
        }

        .source-item.disabled {
            opacity: 0.6;
            border-left-color: #718096;
        }

        .source-status {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 1rem;
        }

        .source-status.active {
            background: #38a169;
            color: white;
        }

        .source-status.error {
            background: #e53e3e;
            color: white;
        }

        .source-status.pending {
            background: #d69e2e;
            color: white;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #2d3748;
            border-radius: 10px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3182ce, #63b3ed);
            width: 0%;
            transition: width 0.3s ease;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .pulsing {
            animation: pulse 2s infinite;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #3182ce;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üåô Night_watcher Control Dashboard</h1>
        <p>Intelligence Gathering & Analysis Framework</p>
    </div>

    <div class="main-container">
        <div class="sidebar">
            <div class="nav-item active" onclick="showSection('collector')">
                üì° Content Collector
            </div>
            <div class="nav-item" onclick="showSection('analyzer')">
                üîç Content Analyzer
            </div>
            <div class="nav-item" onclick="showSection('knowledge-graph')">
                üï∏Ô∏è Knowledge Graph
            </div>
            <div class="nav-item" onclick="showSection('vector-store')">
                üß† Vector Store
            </div>
            <div class="nav-item" onclick="showSection('monitoring')">
                üìä System Monitoring
            </div>
        </div>

        <div class="content">
            <!-- Content Collector Section -->
            <div id="collector" class="section active">
                <h2>Content Collector</h2>
                
                <div class="status-grid">
                    <div class="status-card">
                        <h4>Collection Status</h4>
                        <div class="value" id="collection-status">Idle</div>
                    </div>
                    <div class="status-card">
                        <h4>Total Documents</h4>
                        <div class="value" id="total-documents">0</div>
                    </div>
                    <div class="status-card">
                        <h4>Pending Analysis</h4>
                        <div class="value" id="pending-analysis">0</div>
                    </div>
                    <div class="status-card">
                        <h4>LLM Status</h4>
                        <div class="value" id="llm-status">Unknown</div>
                    </div>
                </div>

                <div class="control-grid">
                    <div class="control-panel">
                        <h3>Collection Controls</h3>
                        <div class="form-group">
                            <label>Collection Mode</label>
                            <select id="collection-mode">
                                <option value="auto">Auto (Smart Detection)</option>
                                <option value="incremental">Incremental (Since Last Run)</option>
                                <option value="first_run">First Run (From Jan 2025)</option>
                                <option value="full">Full (All Since Inauguration)</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="startCollection()">Start Collection</button>
                        <button class="btn btn-danger" onclick="stopCollection()">Stop Collection</button>
                    </div>

                    <div class="control-panel">
                        <h3>Quick Actions</h3>
                        <button class="btn btn-success" onclick="runFullPipeline()">Run Full Pipeline</button>
                        <button class="btn btn-warning" onclick="testLLMConnection()">Test LLM Connection</button>
                        <button class="btn btn-primary" onclick="refreshStatus()">Refresh Status</button>
                    </div>
                </div>

                <div class="progress-bar">
                    <div class="progress-fill" id="task-progress"></div>
                </div>

                <div class="log-container" id="task-log">
                    <div class="log-entry info">[INFO] Ready to start collection</div>
                </div>
            </div>

            <!-- Content Analyzer Section -->
            <div id="analyzer" class="section">
                <h2>Content Analyzer</h2>
                
                <div class="status-grid">
                    <div class="status-card">
                        <h4>Analysis Status</h4>
                        <div class="value" id="analysis-status">Ready</div>
                    </div>
                    <div class="status-card">
                        <h4>Analyzed Documents</h4>
                        <div class="value" id="analyzed-documents">0</div>
                    </div>
                    <div class="status-card">
                        <h4>Pending Analysis</h4>
                        <div class="value" id="pending-docs">0</div>
                    </div>
                </div>

                <div class="control-grid">
                    <div class="control-panel">
                        <h3>Analysis Controls</h3>
                        <div class="form-group">
                            <label>Max Articles to Analyze</label>
                            <input type="number" id="max-analyze" value="20" min="1" max="100">
                        </div>
                        <button class="btn btn-primary" onclick="startAnalysis()">Start Analysis</button>
                    </div>
                </div>

                <div class="log-container" id="analyzer-log">
                    <div class="log-entry info">[INFO] Content Analyzer ready</div>
                </div>
            </div>

            <!-- Knowledge Graph Section -->
            <div id="knowledge-graph" class="section">
                <h2>Knowledge Graph</h2>
                
                <div class="status-grid">
                    <div class="status-card">
                        <h4>Total Nodes</h4>
                        <div class="value" id="kg-nodes">0</div>
                    </div>
                    <div class="status-card">
                        <h4>Total Edges</h4>
                        <div class="value" id="kg-edges">0</div>
                    </div>
                </div>

                <div class="control-grid">
                    <div class="control-panel">
                        <h3>Graph Operations</h3>
                        <button class="btn btn-primary" onclick="buildKnowledgeGraph()">Build Graph</button>
                        <button class="btn btn-success" onclick="syncVectors()">Sync Vectors</button>
                    </div>
                </div>

                <div class="log-container" id="kg-log">
                    <div class="log-entry info">[INFO] Knowledge Graph ready</div>
                </div>
            </div>

            <!-- Vector Store Section -->
            <div id="vector-store" class="section">
                <h2>Vector Store</h2>
                
                <div class="status-grid">
                    <div class="status-card">
                        <h4>Total Vectors</h4>
                        <div class="value" id="total-vectors">0</div>
                    </div>
                </div>

                <div class="control-grid">
                    <div class="control-panel">
                        <h3>Search Interface</h3>
                        <div class="form-group">
                            <label>Search Query</label>
                            <input type="text" id="vector-search" placeholder="Enter search query...">
                        </div>
                        <button class="btn btn-primary" onclick="searchVectors()">Search</button>
                    </div>
                </div>

                <div class="log-container" id="vector-log">
                    <div class="log-entry info">[INFO] Vector Store ready</div>
                </div>
            </div>

            <!-- System Monitoring Section -->
            <div id="monitoring" class="section">
                <h2>System Monitoring</h2>
                
                <div class="status-grid">
                    <div class="status-card">
                        <h4>System Status</h4>
                        <div class="value" style="color: #68d391;">Online</div>
                    </div>
                    <div class="status-card">
                        <h4>Current Task</h4>
                        <div class="value" id="current-task">None</div>
                    </div>
                </div>

                <div class="log-container" id="system-log">
                    <div class="log-entry info">[INFO] System monitoring active</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API configuration
        const API_BASE = window.location.origin + '/api';
        
        // State
        let taskInterval = null;
        let statusInterval = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            refreshStatus();
            startStatusPolling();
        });

        // Navigation
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            document.getElementById(sectionId).classList.add('active');
            event.target.classList.add('active');
        }

        // API calls
        async function apiCall(endpoint, options = {}) {
            try {
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    ...options
                });
                
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('API call failed:', error);
                throw error;
            }
        }

        // Status updates
        async function refreshStatus() {
            try {
                const status = await apiCall('/status');
                
                // Update UI
                document.getElementById('total-documents').textContent = status.total_documents || 0;
                document.getElementById('pending-analysis').textContent = status.pending_analysis || 0;
                document.getElementById('analyzed-documents').textContent = status.analyzed_documents || 0;
                document.getElementById('pending-docs').textContent = status.pending_analysis || 0;
                document.getElementById('kg-nodes').textContent = status.graph_nodes || 0;
                document.getElementById('kg-edges').textContent = status.graph_edges || 0;
                document.getElementById('total-vectors').textContent = status.vector_count || 0;
                
                // LLM status
                const llmConnected = status.system?.llm_connected;
                document.getElementById('llm-status').textContent = llmConnected ? 'Connected' : 'Offline';
                document.getElementById('llm-status').style.color = llmConnected ? '#68d391' : '#fc8181';
                
                // Task status
                if (status.task_status?.running) {
                    document.getElementById('collection-status').textContent = 'Running';
                    document.getElementById('collection-status').parentElement.classList.add('pulsing');
                    document.getElementById('current-task').textContent = status.task_status.current_task || 'Unknown';
                    startTaskPolling();
                } else {
                    document.getElementById('collection-status').textContent = 'Idle';
                    document.getElementById('collection-status').parentElement.classList.remove('pulsing');
                    document.getElementById('current-task').textContent = 'None';
                }
                
            } catch (error) {
                logMessage('system-log', 'error', `Failed to refresh status: ${error.message}`);
            }
        }

        function startStatusPolling() {
            statusInterval = setInterval(refreshStatus, 5000);
        }

        // Task monitoring
        async function updateTaskStatus() {
            try {
                const taskStatus = await apiCall('/task-status');
                
                // Update progress
                const progress = taskStatus.progress || 0;
                document.getElementById('task-progress').style.width = progress + '%';
                
                // Update logs
                if (taskStatus.messages && taskStatus.messages.length > 0) {
                    const logContainer = document.getElementById('task-log');
                    logContainer.innerHTML = '';
                    
                    taskStatus.messages.forEach(msg => {
                        const entry = document.createElement('div');
                        entry.className = `log-entry ${msg.level}`;
                        entry.textContent = `[${msg.time}] ${msg.message}`;
                        logContainer.appendChild(entry);
                    });
                    
                    logContainer.scrollTop = logContainer.scrollHeight;
                }
                
                // Stop polling if task is done
                if (!taskStatus.running && taskInterval) {
                    clearInterval(taskInterval);
                    taskInterval = null;
                    refreshStatus();
                }
                
            } catch (error) {
                console.error('Failed to update task status:', error);
            }
        }

        function startTaskPolling() {
            if (!taskInterval) {
                updateTaskStatus();
                taskInterval = setInterval(updateTaskStatus, 1000);
            }
        }

        // Collection functions
        async function startCollection() {
            const mode = document.getElementById('collection-mode').value;
            
            try {
                await apiCall('/collect', {
                    method: 'POST',
                    body: JSON.stringify({ mode })
                });
                
                logMessage('task-log', 'info', 'Collection started');
                startTaskPolling();
                
            } catch (error) {
                logMessage('task-log', 'error', `Failed to start collection: ${error.message}`);
            }
        }

        async function stopCollection() {
            // In a real implementation, we'd have a stop endpoint
            logMessage('task-log', 'warning', 'Stop function not implemented yet');
        }

        // Analysis functions
        async function startAnalysis() {
            const maxArticles = parseInt(document.getElementById('max-analyze').value);
            
            try {
                await apiCall('/analyze', {
                    method: 'POST',
                    body: JSON.stringify({ max_articles: maxArticles })
                });
                
                logMessage('analyzer-log', 'info', 'Analysis started');
                startTaskPolling();
                
            } catch (error) {
                logMessage('analyzer-log', 'error', `Failed to start analysis: ${error.message}`);
            }
        }

        // Knowledge Graph functions
        async function buildKnowledgeGraph() {
            try {
                await apiCall('/build-kg', { method: 'POST' });
                logMessage('kg-log', 'info', 'Building knowledge graph');
                startTaskPolling();
            } catch (error) {
                logMessage('kg-log', 'error', `Failed to build graph: ${error.message}`);
            }
        }

        async function syncVectors() {
            try {
                await apiCall('/sync-vectors', { method: 'POST' });
                logMessage('vector-log', 'info', 'Synchronizing vectors');
                startTaskPolling();
            } catch (error) {
                logMessage('vector-log', 'error', `Failed to sync vectors: ${error.message}`);
            }
        }

        // Full pipeline
        async function runFullPipeline() {
            try {
                await apiCall('/pipeline', { method: 'POST' });
                logMessage('task-log', 'info', 'Full pipeline started');
                startTaskPolling();
            } catch (error) {
                logMessage('task-log', 'error', `Failed to start pipeline: ${error.message}`);
            }
        }

        // LLM test
        async function testLLMConnection() {
            try {
                const result = await apiCall('/test-llm', { method: 'POST' });
                logMessage('task-log', 'success', `LLM test: ${result.response || 'Connected'}`);
            } catch (error) {
                logMessage('task-log', 'error', `LLM test failed: ${error.message}`);
            }
        }

        // Vector search
        async function searchVectors() {
            const query = document.getElementById('vector-search').value;
            
            if (!query) {
                alert('Please enter a search query');
                return;
            }
            
            try {
                const results = await apiCall('/search', {
                    method: 'POST',
                    body: JSON.stringify({ query, limit: 10 })
                });
                
                logMessage('vector-log', 'success', `Found ${results.length} results`);
                
                // Display results
                results.forEach(result => {
                    logMessage('vector-log', 'info', `${result.name} (score: ${result.score.toFixed(3)})`);
                });
                
            } catch (error) {
                logMessage('vector-log', 'error', `Search failed: ${error.message}`);
            }
        }

        // Utility functions
        function logMessage(containerId, level, message) {
            const container = document.getElementById(containerId);
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry ${level}`;
            entry.textContent = `[${timestamp}] ${message}`;
            
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
            
            // Keep only last 50 entries
            while (container.children.length > 50) {
                container.removeChild(container.firstChild);
            }
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (statusInterval) clearInterval(statusInterval);
            if (taskInterval) clearInterval(taskInterval);
        });
    </script>
</body>
</html>
